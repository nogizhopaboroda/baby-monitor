#!/usr/bin/env node


/*
 *  Usage:
 *  stdin_distributor [duplicated_fifo_1 duplicated_fifo2 ...] < source_fifo
 * */

const fs = require('fs');


console.log('initialising');

const source = process.argv[2];
const targets = process.argv.slice(3);

const readStream = fs.createReadStream(source);

const duplicateStream = (fileName) => {
  console.log(`creating stream: ${source} -> ${fileName}`);
  const writeStream = fs.createWriteStream(fileName);

  const writeToStream = data => writeStream.write(data);

  readStream.on('data', writeToStream);

  writeStream.on('error', (e) => {
    console.log(`consumer of "${fileName}" disconnected`);
    readStream.off('data', writeToStream);
    duplicateStream(fileName);
  });
}

targets.forEach(duplicateStream);

readStream.on('end', () => {
  console.log('exiting');
  process.kill( process.pid, 'SIGTERM' );
});
